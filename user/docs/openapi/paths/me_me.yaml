meMeStatus:
  get:
    operationId: getMeMeStatus
    summary: Get me.me status and peer presence
    description: >
      Returns self profile plus current peer/discovery summary.
      Includes peer presence/connection snapshots and discovery runtime state.
      Discovery and route selection are automatic (LAN/BLE/gateway fallback);
      agents should not orchestrate low-level transport.
    tags: [MeMe]
    responses:
      '200':
        description: Self profile and peer discovery state.
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  const: ok
                self:
                  type: object
                  description: This device's me.me identity profile.
                peers:
                  type: array
                  items:
                    type: object
                  description: Known peer devices with presence/connection snapshots.
                discovery:
                  type: object
                  description: Discovery runtime state.

meMeProvisionStatus:
  get:
    operationId: getMeMeProvisionStatus
    summary: Get device provisioning status
    description: >
      Returns the current provisioning state: whether this device is
      provisioned (signed in), the account subject, the local device
      identity, and the list of sibling devices linked to the same account.
    tags: [MeMe]
    responses:
      '200':
        description: Provisioning status and linked device list.
        content:
          application/json:
            schema:
              type: object
              required: [status, provisioned]
              properties:
                status:
                  type: string
                  const: ok
                provisioned:
                  type: boolean
                  description: Whether the device is provisioned (signed in with a valid signaling token).
                user_subject:
                  type: string
                  nullable: true
                  description: Account subject identifier, or null if not provisioned.
                device_id:
                  type: string
                  description: This device's unique identifier.
                device_name:
                  type: string
                  description: This device's display name.
                devices:
                  type: array
                  items:
                    type: object
                    properties:
                      device_id:
                        type: string
                      device_name:
                        type: string
                  description: All devices linked to the same account (including self).
                claimed_at:
                  type: integer
                  format: int64
                  nullable: true
                  description: Unix epoch millis when provisioning was completed, or null.
                p2p_enabled:
                  type: boolean
                  description: Whether P2P (WebRTC DataChannel) is enabled.
                signaling_token_configured:
                  type: boolean
                  description: Whether a signaling token is configured for P2P.

meMeProvisionRefresh:
  post:
    operationId: postMeMeProvisionRefresh
    summary: Refresh provisioned device list from gateway
    description: >
      Fetches the latest sibling device list from the provisioning gateway
      and saves it locally. Call this after a new device provisions under the
      same account, or to ensure the device list is up to date. The device
      list is also refreshed automatically via push notification when
      siblings change.
    tags: [MeMe]
    requestBody:
      required: false
      content:
        application/json:
          schema:
            type: object
          example: {}
    responses:
      '200':
        description: Device list refreshed successfully.
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  const: ok
                user_subject:
                  type: string
                  description: Account subject identifier.
                devices:
                  type: array
                  items:
                    type: object
                    properties:
                      device_id:
                        type: string
                      device_name:
                        type: string
                  description: Updated list of sibling devices.
      '503':
        description: Gateway unreachable or returned an error.
        content:
          application/json:
            schema:
              $ref: '../components/schemas.yaml#/ErrorResponse'
            example:
              status: error
              error: refresh_failed

meMeMessageSend:
  post:
    operationId: postMeMeMessageSend
    summary: Send encrypted content to a peer
    description: >
      Send structured content to a peer device using automatic route
      selection (LAN/BLE/gateway fallback). Supports multiple payload formats:

      - Preferred: `{"peer_device_id":"...","type":"request","payload":{...}}`

      - Text shortcut: `{"peer_device_id":"...","text":"..."}`

      - Backward compat: `{"peer_device_id":"...","message":"..."}` (string normalized to payload.text)

      - Object shortcut: `{"peer_device_id":"...","message":{"type":"...","...":...}}` (type becomes message type)


      Message type determines remote handling:

      - `request` / `agent_request` / `task` / `command` / `agent_task`: triggers
        the remote agent to process and respond. Use when asking the peer to take action.

      - `message`: informational only â€” stored but does NOT trigger the remote agent
        (unless priority is high/urgent).

      When asking a remote device to do something, always use type `request`.


      Connection security: offer token signed with Ed25519 (fallback ECDSA P-256),
      session key from X25519 (fallback ECDH P-256) + HKDF-SHA256,
      payload encrypted with AES-GCM.


      Inbound content arrives as `me.me.received` events forwarded to
      `/brain/inbox/event` with fields: received_origin (peer|external),
      received_transport (lan|ble|gateway), received_provider (direct|generic|<name>),
      received_kind (message|audio|discord.message|slack.event|...).
    tags: [MeMe]
    x-permission:
      tool: device.me_me
      capability: me_me
    requestBody:
      required: true
      content:
        application/json:
          schema:
            allOf:
              - type: object
                required: [peer_device_id]
                properties:
                  peer_device_id:
                    type: string
                    description: Target peer device ID.
                  type:
                    type: string
                    description: >
                      Message type. Use `request` to trigger the remote agent
                      (also: agent_request, task, command, agent_task).
                      Use `message` for informational content that does not
                      require remote agent action.
                  payload:
                    type: object
                    description: Structured message payload (preferred format).
                  text:
                    type: string
                    description: Text shortcut (alternative to payload).
                  message:
                    description: >
                      Backward-compatible field. String is normalized to
                      payload.text; object's type becomes message type.
              - $ref: '../components/schemas.yaml#/PermissionFields'
          examples:
            request:
              summary: Request remote agent action (preferred)
              value:
                peer_device_id: "d_a1b2c3"
                type: request
                payload:
                  text: "Take a photo and send it back"
            text_shortcut:
              summary: Informational text (no remote agent action)
              value:
                peer_device_id: "d_a1b2c3"
                text: "Hello from my device"
    responses:
      '200':
        description: Message sent via automatic route selection.
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  const: ok
                route:
                  type: string
                  description: Transport used (lan, ble, gateway).
      '400':
        description: Empty content or missing peer_device_id.
        content:
          application/json:
            schema:
              $ref: '../components/schemas.yaml#/ErrorResponse'
            example:
              status: error
              error: payload_required
      '403':
        description: Permission required.
        content:
          application/json:
            schema:
              $ref: '../components/schemas.yaml#/PermissionRequiredResponse'
