<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kugutz</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f4f1ea;
      --panel: #fffaf0;
      --ink: #2c2b28;
      --accent: #d24b2a;
      --muted: #7a7369;
      --border: #e4dccb;
      font-family: "Georgia", "Times New Roman", serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
    }
    header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, #f7efe1, #f2e6d1);
    }
    .wrap {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 16px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.05);
    }
    .row {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 12px;
    }
    .row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.2px;
    }
    .muted { color: var(--muted); }
    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn.secondary {
      background: #8a867d;
    }
    .btn.danger {
      background: #d84b4b;
    }
    textarea {
      width: 100%;
      min-height: 90px;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      font-family: inherit;
    }
    pre {
      margin: 0;
      white-space: pre-wrap;
    }
    ul {
      margin: 8px 0 0 0;
      padding: 0;
      list-style: none;
    }
    li {
      padding: 6px 8px;
      border-bottom: 1px solid var(--border);
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #efe6d3;
      color: var(--muted);
      margin-left: 8px;
    }
    .status-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #999;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
      cursor: pointer;
    }
    .status-dot.ok { background: #2e7d32; }
    .status-dot.offline { background: #c62828; }
    .status-dot.starting { background: #616161; }
    .status-dot.stopping { background: #8d6e63; }
    .inline-status {
      display: inline-block;
      margin-left: 8px;
      font-size: 12px;
      color: var(--muted);
      padding: 2px 6px;
      border-radius: 999px;
      background: #efe6d3;
    }
    .inline-status.ok { background: #e1f1e2; color: #2e7d32; }
    .inline-status.warn { background: #fff2cc; color: #8d6e63; }
    .inline-status.bad { background: #f8d7da; color: #c62828; }
    .inline-status.neutral { background: #efe6d3; color: var(--muted); }
    .row-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: #2c2b28;
      color: #fffaf0;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      box-shadow: 0 8px 20px rgba(0,0,0,0.18);
      z-index: 999;
    }
    .toast.show {
      opacity: 0.95;
    }
    @media (max-width: 820px) {
      .row, .row-3 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Kugutz</h1>
    <div class="muted">Local agent UI shell (WebView)</div>
  </header>
  <div class="wrap">
    <div class="panel">
      <strong>Status</strong>
      <div class="status-row">
        <span id="statusDot" class="status-dot starting"></span>
        <div class="muted" id="status">Booting local service...</div>
      </div>
      <div class="muted" id="statusDetail">Last action: (none)</div>
      <div class="muted" id="session">Session: (none)</div>
      <div class="row-actions">
        <button class="btn secondary" id="restartPython">Restart Python</button>
        <button class="btn danger" id="stopPython">Stop Python</button>
      </div>
    </div>

    <div class="row">
    <div class="panel">
      <strong>Chat</strong><span class="inline-status" id="chatStatus"></span>
      <ul id="chatHistory"></ul>
        <textarea id="chatInput" placeholder="Ask the agent..."></textarea>
        <div class="row-actions">
          <button class="btn" id="sendBtn">Send</button>
          <button class="btn secondary" id="toolBtn">Invoke Tool (filesystem)</button>
        </div>
        <div class="row-actions">
          <input id="fsPath" type="text" placeholder="Path (relative)" style="flex:1; min-width: 140px;" />
          <button class="btn secondary" id="fsList">List Path</button>
        </div>
        <div class="row-actions">
          <select id="permScope">
            <option value="once">One-time</option>
            <option value="session">Session (minutes)</option>
          </select>
          <input id="permDuration" type="number" min="1" placeholder="30" style="width: 80px;" />
        </div>
      </div>
      <div class="panel">
        <strong>Logs</strong>
        <pre id="logStream">(no logs yet)</pre>
      </div>
    </div>

    <div class="row-3">
    <div class="panel">
      <strong>Permissions</strong><span class="inline-status" id="permStatus"></span>
      <div class="muted">Pending requests</div>
        <ul id="permList"></ul>
      </div>
    <div class="panel">
      <strong>Shell</strong><span class="inline-status" id="shellStatus"></span>
      <div class="muted">Allowlisted commands: ls, pwd, whoami</div>
        <div class="row-actions">
          <select id="shellCmd">
            <option value="ls">ls</option>
            <option value="pwd">pwd</option>
            <option value="whoami">whoami</option>
          </select>
          <button class="btn secondary" id="shellRun">Run</button>
        </div>
        <pre id="shellOut">(no output yet)</pre>
      </div>
    <div class="panel">
      <strong>Audit</strong><span class="inline-status" id="auditStatus"></span>
      <div class="muted">Recent events</div>
        <ul id="auditList"></ul>
      </div>
      <div class="panel">
        <strong>Notifications</strong>
        <div class="muted">Native notification channel placeholder</div>
      </div>
    <div class="panel">
      <strong>Webhooks</strong><span class="inline-status" id="hookStatus"></span>
      <div class="muted">Slack/Discord</div>
        <div class="row-actions">
          <select id="hookProvider">
            <option value="slack">Slack</option>
            <option value="discord">Discord</option>
          </select>
          <input id="hookUrl" type="text" placeholder="Webhook URL" style="flex:1; min-width: 140px;" />
        </div>
        <div class="row-actions">
          <button class="btn" id="hookSave">Save</button>
          <button class="btn secondary" id="hookTest">Test</button>
        </div>
      </div>
    <div class="panel">
      <strong>OAuth</strong><span class="inline-status" id="oauthInlineStatus"></span>
      <div class="muted">In-App Browser (Custom Tabs)</div>
        <div class="row-actions">
          <select id="oauthProvider">
            <option value="openai">OpenAI</option>
            <option value="claude">Claude</option>
            <option value="kimi">Kimi</option>
          </select>
          <button class="btn" id="oauthConnect">Connect</button>
          <button class="btn secondary" id="oauthStatus">Status</button>
        </div>
        <div class="row-actions">
          <input id="oauthClientId" type="text" placeholder="Client ID" style="flex:1; min-width: 140px;" />
          <input id="oauthClientSecret" type="password" placeholder="Client Secret (optional)" style="flex:1; min-width: 140px;" />
        </div>
        <div class="row-actions">
          <input id="oauthAuthUrl" type="text" placeholder="Auth URL" style="flex:1; min-width: 140px;" />
          <input id="oauthTokenUrl" type="text" placeholder="Token URL" style="flex:1; min-width: 140px;" />
        </div>
        <div class="row-actions">
          <input id="oauthRedirect" type="text" placeholder="Redirect URI" value="kugutz://oauth" style="flex:1; min-width: 140px;" />
          <input id="oauthScope" type="text" placeholder="Scope" style="flex:1; min-width: 140px;" />
        </div>
        <div class="row-actions">
          <button class="btn" id="oauthSave">Save Config</button>
        </div>
        <div class="muted" id="oauthStatusText">Status: unknown</div>
      </div>
    <div class="panel">
      <strong>API Keys</strong><span class="inline-status" id="keyInlineStatus"></span>
      <div class="muted">Stored locally (SQLCipher if available)</div>
        <div class="row-actions">
          <select id="keyProvider">
            <option value="openai">OpenAI</option>
            <option value="claude">Claude</option>
            <option value="kimi">Kimi</option>
          </select>
          <input id="keyValue" type="password" placeholder="API Key" style="flex:1; min-width: 140px;" />
        </div>
        <div class="row-actions">
          <button class="btn" id="keySave">Save</button>
          <button class="btn secondary" id="keyStatus">Status</button>
          <button class="btn secondary" id="keyDelete">Delete</button>
        </div>
        <div class="muted" id="keyStatusText">Status: unknown</div>
      </div>
    </div>
  </div>
  <div id="toast" class="toast">Notice</div>

  <script>
    const statusEl = document.getElementById("status");
    const statusDot = document.getElementById("statusDot");
    const statusDetail = document.getElementById("statusDetail");
    const toast = document.getElementById("toast");
    const restartPython = document.getElementById("restartPython");
    const stopPython = document.getElementById("stopPython");
    const chatStatus = document.getElementById("chatStatus");
    const permStatus = document.getElementById("permStatus");
    const shellStatus = document.getElementById("shellStatus");
    const auditStatus = document.getElementById("auditStatus");
    const hookStatus = document.getElementById("hookStatus");
    const oauthInlineStatus = document.getElementById("oauthInlineStatus");
    const keyInlineStatus = document.getElementById("keyInlineStatus");
    const sessionEl = document.getElementById("session");
    const logStream = document.getElementById("logStream");
    const chatHistory = document.getElementById("chatHistory");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const toolBtn = document.getElementById("toolBtn");
    const permList = document.getElementById("permList");
    const auditList = document.getElementById("auditList");
    const fsPath = document.getElementById("fsPath");
    const fsList = document.getElementById("fsList");
    const permScope = document.getElementById("permScope");
    const permDuration = document.getElementById("permDuration");
    const shellCmd = document.getElementById("shellCmd");
    const shellRun = document.getElementById("shellRun");
    const shellOut = document.getElementById("shellOut");
    const hookProvider = document.getElementById("hookProvider");
    const hookUrl = document.getElementById("hookUrl");
    const hookSave = document.getElementById("hookSave");
    const hookTest = document.getElementById("hookTest");
    const oauthProvider = document.getElementById("oauthProvider");
    const oauthConnect = document.getElementById("oauthConnect");
    const oauthStatus = document.getElementById("oauthStatus");
    const oauthSave = document.getElementById("oauthSave");
    const oauthClientId = document.getElementById("oauthClientId");
    const oauthClientSecret = document.getElementById("oauthClientSecret");
    const oauthAuthUrl = document.getElementById("oauthAuthUrl");
    const oauthTokenUrl = document.getElementById("oauthTokenUrl");
    const oauthRedirect = document.getElementById("oauthRedirect");
    const oauthScope = document.getElementById("oauthScope");
    const oauthStatusText = document.getElementById("oauthStatusText");
    const keyProvider = document.getElementById("keyProvider");
    const keyValue = document.getElementById("keyValue");
    const keySave = document.getElementById("keySave");
    const keyStatus = document.getElementById("keyStatus");
    const keyDelete = document.getElementById("keyDelete");
    const keyStatusText = document.getElementById("keyStatusText");

    let restartPending = false;
    let restartPendingTimer = null;
    const oauthPresets = {
      openai: { auth_url: "", token_url: "", scope: "" },
      claude: { auth_url: "", token_url: "", scope: "" },
      kimi: { auth_url: "", token_url: "", scope: "" }
    };

    let sessionId = null;

    function appendLog(line) {
      if (logStream.textContent === "(no logs yet)") logStream.textContent = "";
      logStream.textContent += line + "\n";
    }

    function setStatusDetail(text) {
      const ts = new Date().toLocaleTimeString();
      statusDetail.textContent = `${text} @ ${ts}`;
    }

    function appendChat(role, content) {
      const li = document.createElement("li");
      li.textContent = `${role}: ${content}`;
      chatHistory.appendChild(li);
    }

    async function ping() {
      try {
        const res = await fetch("http://127.0.0.1:8765/health");
        if (res.ok) {
          statusEl.textContent = "Local service online";
          if (!sessionId) {
            await ensureSession();
          }
        } else {
          statusEl.textContent = "Local service error";
        }
      } catch (err) {
        statusEl.textContent = "Waiting for local service...";
      }
    }

    function setStatusDot(state) {
      statusDot.classList.remove("ok", "offline", "starting", "stopping");
      statusDot.classList.add(state);
    }

    function persistPythonStatus(status, dotState) {
      try {
        localStorage.setItem("pythonStatus", JSON.stringify({
          status: status || "",
          dot: dotState || "starting"
        }));
      } catch (_) {
        // ignore
      }
    }

    function restorePythonStatus() {
      try {
        const raw = localStorage.getItem("pythonStatus");
        if (!raw) return;
        const data = JSON.parse(raw);
        if (!data) return;
        const normalized = (data.status || "").toLowerCase();
        if (normalized === "ok") {
          statusEl.textContent = "Python: OK (native)";
        } else if (normalized === "offline") {
          statusEl.textContent = "Python: offline (native)";
        } else {
          statusEl.textContent = "Python: starting (native)";
        }
        setStatusDot(data.dot || "starting");
      } catch (_) {
        // ignore
      }
    }

    window.onPythonStatus = function(status) {
      const normalized = (status || "").toLowerCase();
      if (normalized === "ok") {
        statusEl.textContent = "Python: OK (native)";
        setStatusDot("ok");
        persistPythonStatus(status, "ok");
        setStatusDetail("Python reported OK");
        if (restartPending) {
          restartPending = false;
          if (restartPendingTimer) {
            clearTimeout(restartPendingTimer);
            restartPendingTimer = null;
          }
          showToast("Python restarted");
          appendLog("[status] restart complete");
        }
      } else if (normalized === "stopping") {
        statusEl.textContent = "Python: stopping (native)";
        setStatusDot("stopping");
        persistPythonStatus(status, "stopping");
        setStatusDetail("Python stopping");
      } else if (normalized === "offline") {
        statusEl.textContent = "Python: offline (native)";
        setStatusDot("offline");
        persistPythonStatus(status, "offline");
        setStatusDetail("Python offline");
      } else {
        statusEl.textContent = "Python: starting (native)";
        setStatusDot("starting");
        persistPythonStatus(status, "starting");
        setStatusDetail("Python starting");
      }
    };

    window.onPythonRestartRequested = function() {
      restartPending = true;
      if (restartPendingTimer) {
        clearTimeout(restartPendingTimer);
      }
      restartPendingTimer = setTimeout(() => {
        restartPending = false;
        setStatusDetail("Restart timed out");
      }, 30000);
    };

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2000);
    }

    statusDot.addEventListener("click", () => {
      if (typeof AndroidBridge !== "undefined" && AndroidBridge.showPythonServiceDialog) {
        AndroidBridge.showPythonServiceDialog();
      } else {
        showToast("Open the native app to restart the Python service.");
      }
    });

    async function ensureSession() {
      if (sessionId) return;
      try {
        const res = await fetch("http://127.0.0.1:8765/sessions", { method: "POST" });
        const data = await res.json();
        sessionId = data.id;
        sessionEl.textContent = `Session: ${sessionId}`;
      } catch (err) {
        sessionEl.textContent = "Session: (failed)";
      }
    }

    setInterval(() => {
      if (!sessionId) ensureSession();
    }, 5000);

    function setInlineStatus(el, text, tone = "neutral") {
      if (!el) return;
      el.textContent = text || "";
      el.classList.remove("ok", "warn", "bad", "neutral");
      el.classList.add(tone);
      try {
        localStorage.setItem(`status:${el.id}`, JSON.stringify({ text, tone }));
      } catch (_) {
        // ignore
      }
    }

    function restoreInlineStatus(el) {
      if (!el) return;
      try {
        const raw = localStorage.getItem(`status:${el.id}`);
        if (!raw) return;
        const data = JSON.parse(raw);
        setInlineStatus(el, data.text, data.tone);
      } catch (_) {
        // ignore
      }
    }

    async function sendMessage() {
      const content = chatInput.value.trim();
      if (!content || !sessionId) return;
      appendChat("user", content);
      chatInput.value = "";
      await fetch(`http://127.0.0.1:8765/sessions/${sessionId}/messages`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ role: "user", content })
      });
      setInlineStatus(chatStatus, "sent", "ok");
      showToast("Message sent");
    }

    async function invokeTool(args = {}, requestId = null, toolName = "filesystem", detail = "List files") {
      const res = await fetch(`http://127.0.0.1:8765/tools/${toolName}/invoke`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ detail, args, request_id: requestId })
      });
      if (res.status === 403) {
        const data = await res.json();
        appendLog(`[permission] required: ${data.request.id}`);
        setInlineStatus(permStatus, "blocked", "warn");
        showToast("Permission required");
        await refreshPermissions();
        return;
      }
      const data = await res.json();
      appendLog(`[${toolName}] ${JSON.stringify(data)}`);
      if (toolName === "shell") {
        setInlineStatus(shellStatus, "ran", "ok");
      }
      showToast(`${toolName} complete`);
      return data;
    }

    function nativeConsentAvailable() {
      return typeof AndroidBridge !== "undefined" && AndroidBridge.requestNativeConsent;
    }

    async function refreshPermissions() {
      let data;
      try {
        const res = await fetch("http://127.0.0.1:8765/permissions/pending");
        data = await res.json();
      } catch (err) {
        setInlineStatus(permStatus, "offline", "neutral");
        return;
      }
      permList.innerHTML = "";
      if (!data.pending.length) {
        const li = document.createElement("li");
        li.textContent = "(none)";
        permList.appendChild(li);
        return;
      }
      data.pending.forEach(p => {
        const li = document.createElement("li");
        li.innerHTML = `${p.tool} <span class="pill">${p.id}</span>`;
        const actions = document.createElement("div");
        actions.className = "row-actions";
        const approve = document.createElement("button");
        approve.className = "btn";
        approve.textContent = "Approve";
        approve.onclick = async () => {
          await fetch(`http://127.0.0.1:8765/permissions/${p.id}/approve`, { method: "POST" });
          appendLog(`[permission] approved: ${p.id}`);
          setInlineStatus(permStatus, "approved", "ok");
          showToast("Permission approved");
          await refreshPermissions();
          if (p.tool === "filesystem") {
            await invokeTool({ action: "list", path: fsPath.value.trim() || "." }, p.id, "filesystem");
          } else if (p.tool === "shell") {
            const result = await invokeTool({ cmd: [shellCmd.value] }, p.id, "shell", "Run shell command");
            if (result && result.stdout !== undefined) {
              shellOut.textContent = result.stdout || result.stderr || "(no output)";
            }
          }
        };
        const deny = document.createElement("button");
        deny.className = "btn secondary";
        deny.textContent = "Deny";
        deny.onclick = async () => {
          await fetch(`http://127.0.0.1:8765/permissions/${p.id}/deny`, { method: "POST" });
          appendLog(`[permission] denied: ${p.id}`);
          setInlineStatus(permStatus, "denied", "bad");
          showToast("Permission denied");
          await refreshPermissions();
        };
        actions.appendChild(approve);
        actions.appendChild(deny);

        if (nativeConsentAvailable()) {
          const nativeBtn = document.createElement("button");
          nativeBtn.className = "btn";
          nativeBtn.textContent = "Native Consent";
          nativeBtn.onclick = () => {
            AndroidBridge.requestNativeConsent(p.id, p.tool, p.detail || "");
            setInlineStatus(permStatus, "native", "ok");
            showToast("Opened native consent");
          };
          actions.appendChild(nativeBtn);
        }

        li.appendChild(actions);
        permList.appendChild(li);
      });
    }

    async function refreshAudit() {
      let data;
      try {
        const res = await fetch("http://127.0.0.1:8765/audit/recent?limit=20");
        data = await res.json();
      } catch (err) {
        setInlineStatus(auditStatus, "offline", "neutral");
        return;
      }
      auditList.innerHTML = "";
      if (!data.events.length) {
        const li = document.createElement("li");
        li.textContent = "(none)";
        auditList.appendChild(li);
        setInlineStatus(auditStatus, "idle", "neutral");
        return;
      }
      data.events.forEach(ev => {
        const li = document.createElement("li");
        li.textContent = `${ev.event} @ ${new Date(ev.created_at).toLocaleTimeString()}`;
        auditList.appendChild(li);
      });
      setInlineStatus(auditStatus, "updated", "ok");
    }

    function startLogStream() {
      try {
        const es = new EventSource("http://127.0.0.1:8765/logs/stream");
        es.onmessage = (event) => {
          const payload = JSON.parse(event.data);
          appendLog(`[log] ${payload.event}`);
        };
      } catch (err) {
        appendLog("[log] stream unavailable");
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    toolBtn.addEventListener("click", async () => {
      const scope = permScope.value;
      const durationMin = permScope.value === "session" ? parseInt(permDuration.value || "30", 10) : 0;
      const res = await fetch("http://127.0.0.1:8765/permissions/request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tool: "filesystem", detail: "List files", scope, duration_min: durationMin })
      });
      const req = await res.json();
      appendLog(`[permission] requested: ${req.id}`);
      await refreshPermissions();
    });
    fsList.addEventListener("click", async () => {
      const scope = permScope.value;
      const durationMin = permScope.value === "session" ? parseInt(permDuration.value || "30", 10) : 0;
      const res = await fetch("http://127.0.0.1:8765/permissions/request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tool: "filesystem", detail: "List path", scope, duration_min: durationMin })
      });
      const req = await res.json();
      appendLog(`[permission] requested: ${req.id}`);
      await refreshPermissions();
    });
    shellRun.addEventListener("click", async () => {
      const scope = permScope.value;
      const durationMin = permScope.value === "session" ? parseInt(permDuration.value || "30", 10) : 0;
      const res = await fetch("http://127.0.0.1:8765/permissions/request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tool: "shell", detail: `Run ${shellCmd.value}`, scope, duration_min: durationMin })
      });
      const req = await res.json();
      appendLog(`[permission] requested: ${req.id}`);
      await refreshPermissions();
    });
    hookSave.addEventListener("click", async () => {
      const provider = hookProvider.value;
      const url = hookUrl.value.trim();
      await fetch("http://127.0.0.1:8765/webhooks", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ provider, url, enabled: true })
      });
      appendLog(`[webhook] saved: ${provider}`);
      setInlineStatus(hookStatus, "saved", "ok");
      showToast("Webhook saved");
    });
    hookTest.addEventListener("click", async () => {
      const provider = hookProvider.value;
      await fetch("http://127.0.0.1:8765/webhooks/test", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ provider, message: "Test from Kugutz" })
      });
      appendLog(`[webhook] test sent: ${provider}`);
      setInlineStatus(hookStatus, "tested", "ok");
      showToast("Webhook test sent");
    });
    oauthProvider.addEventListener("change", () => {
      const preset = oauthPresets[oauthProvider.value];
      oauthAuthUrl.value = preset.auth_url;
      oauthTokenUrl.value = preset.token_url;
      oauthScope.value = preset.scope;
      oauthRedirect.value = "kugutz://oauth";
    });
    oauthSave.addEventListener("click", async () => {
      const provider = oauthProvider.value;
      await fetch(`http://127.0.0.1:8765/auth/${provider}/config`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          client_id: oauthClientId.value.trim(),
          client_secret: oauthClientSecret.value.trim(),
          auth_url: oauthAuthUrl.value.trim(),
          token_url: oauthTokenUrl.value.trim(),
          redirect_uri: oauthRedirect.value.trim(),
          scope: oauthScope.value.trim()
        })
      });
      appendLog(`[oauth] config saved: ${provider}`);
      setInlineStatus(oauthInlineStatus, "saved", "ok");
      showToast("OAuth config saved");
    });
    oauthConnect.addEventListener("click", () => {
      const provider = oauthProvider.value;
      if (typeof AndroidBridge !== "undefined" && AndroidBridge.startOAuth) {
        AndroidBridge.startOAuth(provider);
        setInlineStatus(oauthInlineStatus, "connecting", "warn");
        showToast("Opening OAuth in browser");
      } else {
        appendLog("[oauth] native bridge unavailable");
        setInlineStatus(oauthInlineStatus, "unavailable", "bad");
        showToast("OAuth unavailable");
      }
    });
    oauthStatus.addEventListener("click", async () => {
      const provider = oauthProvider.value;
      const res = await fetch(`http://127.0.0.1:8765/auth/${provider}/status`);
      const data = await res.json();
      oauthStatusText.textContent = `Status: ${data.connected ? "connected" : "not connected"}`;
      setInlineStatus(oauthInlineStatus, data.connected ? "connected" : "not connected", data.connected ? "ok" : "warn");
      showToast("OAuth status updated");
    });
    keySave.addEventListener("click", async () => {
      const provider = keyProvider.value;
      await fetch(`http://127.0.0.1:8765/keys/${provider}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ api_key: keyValue.value.trim() })
      });
      appendLog(`[keys] saved: ${provider}`);
      setInlineStatus(keyInlineStatus, "saved", "ok");
      showToast("API key saved");
    });
    keyStatus.addEventListener("click", async () => {
      const provider = keyProvider.value;
      const res = await fetch(`http://127.0.0.1:8765/keys/${provider}/status`);
      const data = await res.json();
      keyStatusText.textContent = `Status: ${data.configured ? "configured" : "not configured"}`;
      setInlineStatus(keyInlineStatus, data.configured ? "configured" : "not configured", data.configured ? "ok" : "warn");
      showToast("API key status updated");
    });
    keyDelete.addEventListener("click", async () => {
      const provider = keyProvider.value;
      await fetch(`http://127.0.0.1:8765/keys/${provider}`, { method: "DELETE" });
      keyStatusText.textContent = "Status: not configured";
      appendLog(`[keys] deleted: ${provider}`);
      setInlineStatus(keyInlineStatus, "deleted", "bad");
      showToast("API key deleted");
    });

    restartPython.addEventListener("click", () => {
      if (typeof AndroidBridge !== "undefined" && AndroidBridge.restartPythonService) {
        AndroidBridge.restartPythonService();
        window.onPythonRestartRequested && window.onPythonRestartRequested();
        showToast("Restart requested");
        appendLog("[action] restart requested");
        statusEl.textContent = "Python: starting (native)";
        setStatusDot("starting");
        persistPythonStatus("starting", "starting");
        setStatusDetail("Restart requested");
      } else if (typeof AndroidBridge !== "undefined" && AndroidBridge.showPythonServiceDialog) {
        AndroidBridge.showPythonServiceDialog();
      } else {
        showToast("Open the native app to restart the Python service.");
      }
    });

    stopPython.addEventListener("click", () => {
      if (typeof AndroidBridge !== "undefined" && AndroidBridge.stopPythonService) {
        if (!confirm("Stop the local Python service?")) return;
        AndroidBridge.stopPythonService();
        showToast("Stop requested");
        appendLog("[action] stop requested");
        statusEl.textContent = "Python: stopping (native)";
        setStatusDot("stopping");
        persistPythonStatus("stopping", "stopping");
        setStatusDetail("Stop requested");
      } else {
        showToast("Open the native app to stop the Python service.");
      }
    });

    setInterval(ping, 2000);
    setInterval(refreshPermissions, 3000);
    setInterval(refreshAudit, 4000);
    ping();
    ensureSession();
    refreshPermissions();
    refreshAudit();
    startLogStream();

    [
      chatStatus,
      permStatus,
      shellStatus,
      auditStatus,
      hookStatus,
      oauthInlineStatus,
      keyInlineStatus
    ].forEach(restoreInlineStatus);
    restorePythonStatus();
  </script>
</body>
</html>
