<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kugutz Local Service</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f5f2ea;
        --ink: #2a2a2a;
        --muted: #6b6b6b;
        --card: #fff7e8;
        --accent: #2e7d32;
        --danger: #c62828;
        --warn: #8d6e63;
      }
      body {
        margin: 0;
        font-family: "Georgia", "Times New Roman", serif;
        background: var(--bg);
        color: var(--ink);
        max-width: 100vw;
        overflow-x: hidden;
      }
      header {
        padding: 18px 20px 8px;
      }
      h1 {
        margin: 0 0 4px 0;
        font-size: 26px;
      }
      .sub {
        margin: 0;
        color: var(--muted);
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        padding: 16px 20px 28px;
        width: 100%;
        box-sizing: border-box;
      }
      .card {
        background: var(--card);
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.06);
        box-sizing: border-box;
      }
      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .label {
        font-weight: 700;
      }
      .status {
        font-weight: 700;
      }
      .status.ok { color: var(--accent); }
      .status.offline { color: var(--danger); }
      .status.starting { color: #616161; }
      .status.stopping { color: var(--warn); }
      button {
        border: none;
        border-radius: 999px;
        padding: 10px 14px;
        font-weight: 700;
        cursor: pointer;
        background: #ece3d4;
        color: var(--ink);
      }
      button.primary {
        background: #2e7d32;
        color: white;
      }
      button.danger {
        background: #c62828;
        color: white;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        word-break: break-word;
        overflow-wrap: anywhere;
      }
      @media (max-width: 640px) {
        header {
          padding: 14px 16px 6px;
        }
        .grid {
          padding: 12px 16px 24px;
        }
        .card {
          padding: 14px;
        }
        .row {
          justify-content: flex-start;
        }
        button {
          width: 100%;
        }
      }
      @media (min-width: 720px) {
        .grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <main class="grid">
      <section class="card">
        <div class="row">
          <div>
            <div class="label">SSHD</div>
            <div id="sshStatus" class="status starting">checking</div>
          </div>
        </div>
        <div class="row" style="margin-top: 12px;">
          <label>
            <input type="checkbox" id="sshEnabled" />
            Enable SSHD
          </label>
          <label>
            <input type="checkbox" id="sshNoAuth" />
            Notification auth
          </label>
        </div>
        <div class="row" style="margin-top: 12px;">
          <button id="startPin">Start PIN</button>
        </div>
        <p class="muted" id="pinDetail">PIN auth inactive.</p>
        <p class="muted" id="sshDetail">Waiting for status…</p>
      </section>

      <section class="card">
        <div class="row">
          <div>
            <div class="label">Python Worker</div>
            <div id="pythonStatus" class="status offline">offline</div>
          </div>
        </div>
        <div class="row" style="margin-top: 12px;">
          <button class="primary" id="startPython">Start</button>
          <button id="restartPython">Restart</button>
          <button class="danger" id="stopPython">Stop</button>
        </div>
        <p class="muted" id="pythonDetail">Starts only when requested.</p>
      </section>

      <section class="card">
        <div class="row">
          <div>
            <div class="label">Device IP (Wi‑Fi)</div>
            <div id="wifiIp" class="status">—</div>
          </div>
        </div>
        <p class="muted">Use this to connect via LAN services (SSHD will move to native in this phase).</p>
      </section>

      <section class="card">
        <div class="row">
          <div>
            <div class="label">UI Maintenance</div>
            <div class="muted">Reset the UI files to defaults.</div>
          </div>
          <button id="resetUi">Reset UI</button>
        </div>
      </section>
    </main>

    <script>
      const pythonStatus = document.getElementById("pythonStatus");
      const pythonDetail = document.getElementById("pythonDetail");
      const wifiIp = document.getElementById("wifiIp");
      const sshStatus = document.getElementById("sshStatus");
      const sshEnabled = document.getElementById("sshEnabled");
      const sshNoAuth = document.getElementById("sshNoAuth");
      const sshDetail = document.getElementById("sshDetail");
      const pinDetail = document.getElementById("pinDetail");

      function setStatus(el, value) {
        el.textContent = value;
        el.classList.remove("ok", "offline", "starting", "stopping");
        if (value === "ok") el.classList.add("ok");
        else if (value === "offline") el.classList.add("offline");
        else if (value === "stopping") el.classList.add("stopping");
        else el.classList.add("starting");
      }

      async function refreshPython() {
        try {
          const res = await fetch("http://127.0.0.1:8765/python/status");
          if (!res.ok) throw new Error("status failed");
          const data = await res.json();
          setStatus(pythonStatus, data.status || "offline");
        } catch (_) {
          setStatus(pythonStatus, "offline");
        }
      }

      async function refreshSsh() {
        try {
          const res = await fetch("http://127.0.0.1:8765/ssh/status");
          if (!res.ok) throw new Error("ssh status failed");
          const data = await res.json();
          setStatus(sshStatus, data.running ? "ok" : "offline");
          sshEnabled.checked = !!data.enabled;
          sshNoAuth.checked = !!data.noauth_enabled;
          sshDetail.textContent =
            "Home: " + data.home_dir + " • authorized_keys: " + data.authorized_keys;
        } catch (_) {
          setStatus(sshStatus, "offline");
          sshDetail.textContent = "SSHD status unavailable";
        }
      }

      async function refreshPin() {
        try {
          const res = await fetch("http://127.0.0.1:8765/ssh/pin/status");
          if (!res.ok) throw new Error("pin status failed");
          const data = await res.json();
          if (data.active) {
            const exp = data.expires_at ? new Date(data.expires_at).toLocaleTimeString() : "soon";
            pinDetail.textContent = "PIN auth active until " + exp;
          } else {
            pinDetail.textContent = "PIN auth inactive.";
          }
        } catch (_) {
          pinDetail.textContent = "PIN auth unavailable.";
        }
      }

      async function requestPermission(tool, detail) {
        const res = await fetch("http://127.0.0.1:8765/permissions/request", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ tool, detail, scope: "once" }),
        });
        if (!res.ok) throw new Error("permission request failed");
        const data = await res.json();
        if (data.status === "approved") {
          return data.id;
        }
        const deadline = Date.now() + 30000;
        while (Date.now() < deadline) {
          await new Promise((resolve) => setTimeout(resolve, 500));
          try {
            const statusRes = await fetch("http://127.0.0.1:8765/permissions/" + data.id);
            if (!statusRes.ok) continue;
            const statusData = await statusRes.json();
            if (statusData.status === "approved") {
              return data.id;
            }
            if (statusData.status === "denied") {
              throw new Error("permission denied");
            }
          } catch (_) {
            // ignore and keep polling
          }
        }
        throw new Error("permission timeout");
      }

      document.getElementById("startPython").addEventListener("click", async () => {
        if (typeof AndroidBridge !== "undefined" && AndroidBridge.startPythonWorker) {
          AndroidBridge.startPythonWorker();
        } else {
          await fetch("http://127.0.0.1:8765/python/start", { method: "POST" });
        }
        pythonDetail.textContent = "Starting worker…";
        setStatus(pythonStatus, "starting");
      });
      document.getElementById("restartPython").addEventListener("click", async () => {
        if (typeof AndroidBridge !== "undefined" && AndroidBridge.restartPythonWorker) {
          AndroidBridge.restartPythonWorker();
        } else {
          await fetch("http://127.0.0.1:8765/python/restart", { method: "POST" });
        }
        pythonDetail.textContent = "Restart requested";
        setStatus(pythonStatus, "starting");
      });
      document.getElementById("stopPython").addEventListener("click", async () => {
        if (typeof AndroidBridge !== "undefined" && AndroidBridge.stopPythonWorker) {
          AndroidBridge.stopPythonWorker();
        } else {
          await fetch("http://127.0.0.1:8765/python/stop", { method: "POST" });
        }
        pythonDetail.textContent = "Stop requested";
        setStatus(pythonStatus, "stopping");
      });
      document.getElementById("resetUi").addEventListener("click", () => {
        const ok = window.confirm("Reset UI to defaults? This will overwrite any local changes.");
        if (!ok) return;
        if (typeof AndroidBridge !== "undefined" && AndroidBridge.resetUiToDefaults) {
          AndroidBridge.resetUiToDefaults();
        }
      });
      function refreshIp() {
        if (typeof AndroidBridge !== "undefined" && AndroidBridge.getWifiIp) {
          const ip = AndroidBridge.getWifiIp();
          wifiIp.textContent = ip || "unavailable";
        }
      }
      async function updateSshConfig() {
        const enabled = sshEnabled.checked;
        const noauth_enabled = sshNoAuth.checked;
        try {
          const res = await fetch("http://127.0.0.1:8765/ssh/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ enabled, noauth_enabled }),
          });
          if (!res.ok) throw new Error("apply failed");
          await refreshSsh();
        } catch (_) {
          sshDetail.textContent = "Failed to apply SSHD settings";
        }
      }

      sshEnabled.addEventListener("change", updateSshConfig);
      sshNoAuth.addEventListener("change", updateSshConfig);

      document.getElementById("startPin").addEventListener("click", async () => {
        try {
          const permission_id = await requestPermission("ssh_pin", "Enable SSH PIN auth");
          const res = await fetch("http://127.0.0.1:8765/ssh/pin/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ permission_id, seconds: 10 }),
          });
          if (!res.ok) throw new Error("pin start failed");
          const data = await res.json();
          if (data.pin) {
            alert("PIN: " + data.pin + " (valid ~10 seconds)");
          }
          refreshPin();
        } catch (_) {
          pinDetail.textContent = "PIN auth start failed.";
        }
      });

      window.onPythonStatus = function(status) {
        setStatus(pythonStatus, status);
      };

      refreshPython();
      refreshSsh();
      refreshPin();
      refreshIp();
      setInterval(refreshPython, 5000);
      setInterval(refreshSsh, 5000);
      setInterval(refreshPin, 5000);
      setInterval(refreshIp, 15000);
    </script>
  </body>
</html>
