<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kugutz Local Service</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f5f2ea;
        --ink: #2a2a2a;
        --muted: #6b6b6b;
        --card: #fff7e8;
        --accent: #2e7d32;
        --danger: #c62828;
        --warn: #8d6e63;
      }
      body {
        margin: 0;
        font-family: "Georgia", "Times New Roman", serif;
        background: var(--bg);
        color: var(--ink);
        max-width: 100vw;
        overflow-x: hidden;
      }
      header {
        padding: 18px 20px 8px;
      }
      h1 {
        margin: 0 0 4px 0;
        font-size: 26px;
      }
      .sub {
        margin: 0;
        color: var(--muted);
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        padding: 16px 20px 28px;
        width: 100%;
        box-sizing: border-box;
      }
      .card {
        background: var(--card);
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.06);
        box-sizing: border-box;
      }
      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .label {
        font-weight: 700;
      }
      .status {
        font-weight: 700;
      }
      .status.ok { color: var(--accent); }
      .status.offline { color: var(--danger); }
      .status.starting { color: #616161; }
      .status.stopping { color: var(--warn); }
      button {
        border: none;
        border-radius: 999px;
        padding: 10px 14px;
        font-weight: 700;
        cursor: pointer;
        background: #ece3d4;
        color: var(--ink);
      }
      button.primary {
        background: #2e7d32;
        color: white;
      }
      button.danger {
        background: #c62828;
        color: white;
      }
      .muted {
        color: var(--muted);
        font-size: 14px;
        word-break: break-word;
        overflow-wrap: anywhere;
      }
      .pin-bar {
        width: 100%;
        height: 8px;
        background: #e6dccb;
        border-radius: 999px;
        overflow: hidden;
      }
      .pin-bar-fill {
        height: 100%;
        width: 0%;
        background: #2e7d32;
        transition: width 0.2s ease;
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 999;
      }
      .modal.show {
        display: flex;
      }
      .modal-card {
        width: 100%;
        max-width: 360px;
        background: var(--card);
        border-radius: 16px;
        padding: 18px;
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.2);
      }
      .pin-code {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 2px;
        margin: 8px 0;
      }
      @media (max-width: 640px) {
        header {
          padding: 14px 16px 6px;
        }
        .grid {
          padding: 12px 16px 24px;
        }
        .card {
          padding: 14px;
        }
        .row {
          justify-content: flex-start;
        }
        button {
          width: 100%;
        }
      }
      @media (min-width: 720px) {
        .grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <main class="grid">
      <section class="card">
        <div class="row">
          <div>
            <div class="label">SSHD</div>
            <div id="sshStatus" class="status starting">checking</div>
          </div>
        </div>
        <div class="row" style="margin-top: 12px;">
          <label>
            <input type="checkbox" id="sshEnabled" />
            Enable SSHD
          </label>
        </div>
        <div class="row" style="margin-top: 8px;">
          <label>
            <input type="radio" name="authMethod" id="authPublic" />
            Public-key
          </label>
          <label>
            <input type="radio" name="authMethod" id="authNotification" />
            Notification
          </label>
          <button id="authPin">PIN</button>
        </div>
        <p class="muted" id="sshDetail">Waiting for status…</p>
        <div id="hostKeyRow" style="display:none;margin-top:8px;">
          <div style="display:flex;align-items:center;gap:8px;">
            <span class="muted" style="font-family:monospace;font-size:12px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" id="hostKeyFp"></span>
            <button id="copyHostKey" style="padding:6px 10px;font-size:12px;min-width:auto;width:auto;">Copy</button>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="row">
          <div>
            <div class="label">Python Worker</div>
            <div id="pythonStatus" class="status offline">offline</div>
          </div>
        </div>
        <div class="row" style="margin-top: 12px;">
          <button id="restartPython">Restart</button>
        </div>
        <p class="muted" id="pythonDetail">Emergency restart only.</p>
      </section>

      <section class="card">
        <div class="row">
          <div>
            <div class="label">UI Maintenance</div>
            <div class="muted">Reset the UI files to defaults.</div>
          </div>
          <button id="resetUi">Reset UI</button>
        </div>
      </section>
    </main>
    <div class="modal" id="pinModal" role="dialog" aria-modal="true" aria-labelledby="pinTitle">
      <div class="modal-card">
        <div class="label" id="pinTitle">PIN auth</div>
        <div class="pin-code" id="pinCode">------</div>
        <div class="muted" id="pinCountdown">PIN inactive.</div>
        <div class="pin-bar" aria-hidden="true" style="margin: 10px 0 16px;">
          <div id="pinBarFill" class="pin-bar-fill"></div>
        </div>
        <button class="danger" id="pinClose">End PIN</button>
      </div>
    </div>

    <script>
      const pythonStatus = document.getElementById("pythonStatus");
      const pythonDetail = document.getElementById("pythonDetail");
      const sshStatus = document.getElementById("sshStatus");
      const sshEnabled = document.getElementById("sshEnabled");
      const authPublic = document.getElementById("authPublic");
      const authNotification = document.getElementById("authNotification");
      const authPin = document.getElementById("authPin");
      const sshDetail = document.getElementById("sshDetail");
      const hostKeyRow = document.getElementById("hostKeyRow");
      const hostKeyFp = document.getElementById("hostKeyFp");
      const copyHostKey = document.getElementById("copyHostKey");
      let currentHostKeyPublic = "";
      const pinModal = document.getElementById("pinModal");
      const pinCode = document.getElementById("pinCode");
      const pinCountdown = document.getElementById("pinCountdown");
      const pinClose = document.getElementById("pinClose");
      const pinBarFill = document.getElementById("pinBarFill");
      const pinDurationMs = 20000;
      let pinExpiresAt = null;
      let lastPin = null;
      let lastAuthSelection = "public_key";

      function setStatus(el, value) {
        el.textContent = value;
        el.classList.remove("ok", "offline", "starting", "stopping");
        if (value === "ok") el.classList.add("ok");
        else if (value === "offline") el.classList.add("offline");
        else if (value === "stopping") el.classList.add("stopping");
        else el.classList.add("starting");
      }

      async function refreshPython() {
        try {
          const res = await fetch("http://127.0.0.1:8765/python/status");
          if (!res.ok) throw new Error("status failed");
          const data = await res.json();
          setStatus(pythonStatus, data.status || "offline");
        } catch (_) {
          setStatus(pythonStatus, "offline");
        }
      }

      async function refreshSsh() {
        try {
          const res = await fetch("http://127.0.0.1:8765/ssh/status");
          if (!res.ok) throw new Error("ssh status failed");
          const data = await res.json();
          setStatus(sshStatus, data.running ? "ok" : "offline");
          sshEnabled.checked = !!data.enabled;
          const mode = data.auth_mode || "public_key";
          if (mode !== "pin") {
            lastAuthSelection = mode === "notification" ? "notification" : "public_key";
          }
          authPublic.checked = lastAuthSelection === "public_key";
          authNotification.checked = lastAuthSelection === "notification";
          sshDetail.textContent = "ssh " + (data.host || "aaa.bbb.ccc.ddd") + " -p " + (data.port || 2222);
          if (data.host_key_fingerprint) {
            hostKeyFp.textContent = data.host_key_fingerprint;
            hostKeyRow.style.display = "block";
          } else {
            hostKeyRow.style.display = "none";
          }
          currentHostKeyPublic = data.host_key_public || "";
        } catch (_) {
          setStatus(sshStatus, "offline");
          sshDetail.textContent = "SSHD status unavailable";
          hostKeyRow.style.display = "none";
        }
      }

      async function refreshPin() {
        try {
          const res = await fetch("http://127.0.0.1:8765/ssh/pin/status");
          if (!res.ok) throw new Error("pin status failed");
          const data = await res.json();
          if (data.active) {
            pinExpiresAt = data.expires_at || null;
            if (pinModal && !pinModal.classList.contains("show")) {
              pinModal.classList.add("show");
            }
            if (data.pin) {
              pinCode.textContent = data.pin;
              lastPin = data.pin;
            } else if (lastPin && pinCode.textContent === "------") {
              pinCode.textContent = lastPin;
            }
            updatePinCountdown();
          } else {
            pinExpiresAt = null;
            pinBarFill.style.width = "0%";
            pinCountdown.textContent = "PIN inactive.";
            pinCode.textContent = "------";
            lastPin = null;
            if (pinModal.classList.contains("show")) {
              pinModal.classList.remove("show");
              await refreshSsh();
            }
          }
        } catch (_) {
          pinExpiresAt = null;
          pinBarFill.style.width = "0%";
          pinCountdown.textContent = "PIN unavailable.";
          pinCode.textContent = "------";
          pinModal.classList.remove("show");
        }
      }

      function updatePinCountdown() {
        if (!pinExpiresAt) {
          pinBarFill.style.width = "0%";
          pinCountdown.textContent = "PIN inactive.";
          return;
        }
        const remainingMs = pinExpiresAt - Date.now();
        if (remainingMs <= 0) {
          pinBarFill.style.width = "0%";
          pinExpiresAt = null;
          pinCountdown.textContent = "PIN inactive.";
          pinCode.textContent = "------";
          pinModal.classList.remove("show");
          return;
        }
        const seconds = Math.ceil(remainingMs / 1000);
        pinCountdown.textContent = "Active (" + seconds + "s)";
        const ratio = Math.max(0, Math.min(1, remainingMs / pinDurationMs));
        pinBarFill.style.width = Math.round(ratio * 100) + "%";
      }

      async function requestPermission(tool, detail) {
        const res = await fetch("http://127.0.0.1:8765/permissions/request", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ tool, detail, scope: "once" }),
        });
        if (!res.ok) throw new Error("permission request failed");
        const data = await res.json();
        if (data.status === "approved") {
          return data.id;
        }
        const deadline = Date.now() + 30000;
        while (Date.now() < deadline) {
          await new Promise((resolve) => setTimeout(resolve, 500));
          try {
            const statusRes = await fetch("http://127.0.0.1:8765/permissions/" + data.id);
            if (!statusRes.ok) continue;
            const statusData = await statusRes.json();
            if (statusData.status === "approved") {
              return data.id;
            }
            if (statusData.status === "denied") {
              throw new Error("permission denied");
            }
          } catch (_) {
            // ignore and keep polling
          }
        }
        throw new Error("permission timeout");
      }

      document.getElementById("restartPython").addEventListener("click", async () => {
        if (typeof AndroidBridge !== "undefined" && AndroidBridge.restartPythonWorker) {
          AndroidBridge.restartPythonWorker();
        } else {
          await fetch("http://127.0.0.1:8765/python/restart", { method: "POST" });
        }
        pythonDetail.textContent = "Restart requested";
        setStatus(pythonStatus, "starting");
      });
      document.getElementById("resetUi").addEventListener("click", () => {
        const ok = window.confirm("Reset UI to defaults? This will overwrite any local changes.");
        if (!ok) return;
        if (typeof AndroidBridge !== "undefined" && AndroidBridge.resetUiToDefaults) {
          AndroidBridge.resetUiToDefaults();
        }
      });
      async function updateSshConfig(forcedMode) {
        const enabled = sshEnabled.checked;
        const auth_mode = forcedMode || (authNotification.checked ? "notification" : "public_key");
        try {
          const res = await fetch("http://127.0.0.1:8765/ssh/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ enabled, auth_mode }),
          });
          if (!res.ok) throw new Error("apply failed");
          await refreshSsh();
        } catch (_) {
          sshDetail.textContent = "Failed to apply SSHD settings";
        }
      }

      sshEnabled.addEventListener("change", updateSshConfig);
      authPublic.addEventListener("change", () => {
        authPublic.checked = true;
        authNotification.checked = false;
        updateSshConfig("public_key");
      });
      authNotification.addEventListener("change", () => {
        authNotification.checked = true;
        authPublic.checked = false;
        updateSshConfig("notification");
      });
      authPin.addEventListener("click", async () => {
        try {
          pinCode.textContent = "••••••";
          pinCountdown.textContent = "Generating PIN…";
          pinBarFill.style.width = "0%";
          pinModal.classList.add("show");
          const permission_id = await requestPermission("ssh_pin", "Enable SSH PIN auth");
          const res = await fetch("http://127.0.0.1:8765/ssh/pin/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ permission_id, seconds: 20 }),
          });
          if (!res.ok) throw new Error("pin start failed");
          const data = await res.json();
          if (data.pin) {
            pinCode.textContent = data.pin;
            lastPin = data.pin;
          } else if (lastPin) {
            pinCode.textContent = lastPin;
          } else {
            pinCode.textContent = "PIN unavailable";
          }
          pinModal.classList.add("show");
          pinExpiresAt = data.expires_at || (Date.now() + pinDurationMs);
          updatePinCountdown();
          const cfg = await fetch("http://127.0.0.1:8765/ssh/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ enabled: sshEnabled.checked, auth_mode: "pin" }),
          });
          if (!cfg.ok) throw new Error("pin config failed");
          await refreshSsh();
        } catch (_) {
          sshDetail.textContent = "Failed to start PIN auth";
        }
      });

      copyHostKey.addEventListener("click", async () => {
        if (!currentHostKeyPublic) return;
        try {
          await navigator.clipboard.writeText(currentHostKeyPublic);
          copyHostKey.textContent = "Copied!";
          setTimeout(() => { copyHostKey.textContent = "Copy"; }, 1500);
        } catch (_) {
          copyHostKey.textContent = "Failed";
          setTimeout(() => { copyHostKey.textContent = "Copy"; }, 1500);
        }
      });

      pinClose.addEventListener("click", async () => {
        try {
          const res = await fetch("http://127.0.0.1:8765/ssh/pin/stop", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}),
          });
          if (!res.ok) throw new Error("pin stop failed");
          await refreshPin();
          await refreshSsh();
        } catch (_) {
          // ignore
        } finally {
          pinExpiresAt = null;
          pinBarFill.style.width = "0%";
          pinCountdown.textContent = "PIN inactive.";
          pinCode.textContent = "------";
          lastPin = null;
          pinModal.classList.remove("show");
        }
      });

      window.onPythonStatus = function(status) {
        setStatus(pythonStatus, status);
      };

      refreshPython();
      refreshSsh();
      refreshPin();
      setInterval(refreshPython, 5000);
      setInterval(refreshSsh, 5000);
      setInterval(refreshPin, 1000);
      setInterval(updatePinCountdown, 1000);
    </script>
  </body>
</html>
