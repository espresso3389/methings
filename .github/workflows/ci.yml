name: Android CI & Release

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      test_release_build:
        description: "Run signed release APK build/upload without creating a GitHub Release"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  android-apk-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false
      - name: Prepare third_party sources
        run: |
          set -euo pipefail
          git submodule sync --recursive
          git -c protocol.version=2 submodule update --init --depth=1 third_party/libusb third_party/libuvc
          if ! git -c protocol.version=2 submodule update --init --depth=1 third_party/dropbear; then
            dropbear_branch="$(git config -f .gitmodules --get submodule.third_party/dropbear.branch || true)"
            dropbear_branch="${dropbear_branch:-feat/uv-shell-alias}"
            echo "Falling back to dropbear fork branch '${dropbear_branch}' because pinned submodule commit is unavailable"
            rm -rf third_party/dropbear
            git clone --depth=1 --branch "${dropbear_branch}" https://github.com/espresso3389/dropbear.git third_party/dropbear
            git -C third_party/dropbear log -1 --oneline
          fi
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf \
            automake \
            autoconf-archive \
            build-essential \
            cmake \
            gettext \
            libtool-bin \
            libltdl-dev \
            m4 \
            libtool \
            ninja-build \
            pkg-config \
            pkgconf \
            unzip \
            zip \
            zlib1g-dev
      - name: Install Gradle
        run: |
          curl -fsSL -o /tmp/gradle-8.2.1-bin.zip https://services.gradle.org/distributions/gradle-8.2.1-bin.zip
          sudo unzip -q -o /tmp/gradle-8.2.1-bin.zip -d /opt
          echo "/opt/gradle-8.2.1/bin" >> "$GITHUB_PATH"
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      - name: Install Android NDK
        run: |
          yes | sdkmanager "platforms;android-34" "build-tools;34.0.0" "ndk;29.0.14206865"
      - name: Build libusb/libuvc
        env:
          NDK_DIR: ${{ env.ANDROID_SDK_ROOT }}/ndk/29.0.14206865
        run: |
          ./scripts/build_libusb_android.sh
          ./scripts/build_libuvc_android.sh
      - name: Build Debug APK
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4"
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
          GOOGLE_WEB_CLIENT_ID: ${{ vars.GOOGLE_WEB_CLIENT_ID }}
        run: |
          gradle --project-dir app/android --parallel --build-cache assembleDebug
      - name: Restore signing keystore (tag/manual release test)
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.test_release_build == 'true')
        env:
          ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          test -n "${ANDROID_KEYSTORE_B64}"
          test -n "${ANDROID_KEYSTORE_PASSWORD}"
          test -n "${ANDROID_KEY_ALIAS}"
          test -n "${ANDROID_KEY_PASSWORD}"
          echo "$ANDROID_KEYSTORE_B64" | base64 -d > "$RUNNER_TEMP/release.jks"
          {
            echo "ANDROID_KEYSTORE_PATH=$RUNNER_TEMP/release.jks"
            echo "ANDROID_KEYSTORE_PASSWORD=${ANDROID_KEYSTORE_PASSWORD}"
            echo "ANDROID_KEY_ALIAS=${ANDROID_KEY_ALIAS}"
            echo "ANDROID_KEY_PASSWORD=${ANDROID_KEY_PASSWORD}"
          } >> "$GITHUB_ENV"
      - name: Validate release keystore (tag/manual release test)
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.test_release_build == 'true')
        run: |
          set -euo pipefail
          keytool -list -keystore "$ANDROID_KEYSTORE_PATH" -storepass "$ANDROID_KEYSTORE_PASSWORD" >/dev/null
          if ! keytool -list -keystore "$ANDROID_KEYSTORE_PATH" -storepass "$ANDROID_KEYSTORE_PASSWORD" -alias "$ANDROID_KEY_ALIAS" >/dev/null 2>&1; then
            echo "Configured ANDROID_KEY_ALIAS was not found in the release keystore."
            echo "Available aliases:"
            keytool -list -keystore "$ANDROID_KEYSTORE_PATH" -storepass "$ANDROID_KEYSTORE_PASSWORD" | sed -n 's/^.*, //p'
            exit 1
          fi
          keytool -list -v -keystore "$ANDROID_KEYSTORE_PATH" -storepass "$ANDROID_KEYSTORE_PASSWORD" -alias "$ANDROID_KEY_ALIAS" -keypass "$ANDROID_KEY_PASSWORD" >/dev/null
      - name: Build Release APK (tag/manual release test)
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.test_release_build == 'true')
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4"
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
          GOOGLE_WEB_CLIENT_ID: ${{ vars.GOOGLE_WEB_CLIENT_ID }}
          METHINGS_VERSION_NAME: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || '' }}
          METHINGS_GIT_SHA: ${{ github.sha }}
        run: |
          gradle --project-dir app/android --parallel --build-cache assembleRelease
      - name: Verify Release APK signature (tag/manual release test)
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.test_release_build == 'true')
        run: |
          set -euo pipefail
          "$ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner" verify --verbose --print-certs app/android/app/build/outputs/apk/release/app-release.apk
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: |
            app/android/app/build/outputs/apk/debug/app-debug.apk
            app/android/app/build/outputs/apk/debug/output-metadata.json
      - name: Upload Release APK (tag/manual release test)
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.test_release_build == 'true')
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: |
            app/android/app/build/outputs/apk/release/*.apk
            app/android/app/build/outputs/apk/release/output-metadata.json

  emulator-test:
    runs-on: ubuntu-latest
    needs: android-apk-build
    timeout-minutes: 15
    steps:
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Download debug APK
        uses: actions/download-artifact@v4
        with:
          name: app-debug-apk
          path: apk

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Run emulator test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          force-avd-creation: true
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -no-snapshot-save
          disable-animations: true
          script: |
            echo "::group::Install APK"
            adb install apk/app-debug.apk
            echo "::endgroup::"
            echo "::group::Launch activity"
            adb shell am start -W -n jp.espresso3389.methings/.ui.MainActivity
            echo "::endgroup::"
            sleep 10
            echo "::group::Verify app process"
            adb shell pidof jp.espresso3389.methings || { echo "::error::App process not found -- likely crashed on startup"; adb logcat -d -s AndroidRuntime:E; exit 1; }
            echo "::endgroup::"
            echo "::group::API health check"
            adb forward tcp:33389 tcp:33389
            curl -sf --retry 15 --retry-delay 2 --retry-all-errors http://127.0.0.1:33389/health
            echo ""
            echo "::endgroup::"
            echo "::group::App update endpoint smoke check"
            curl -sS -f --retry 5 --retry-delay 2 --retry-all-errors http://127.0.0.1:33389/app/update/check -o app_update_check.json || true
            test -s app_update_check.json || { echo "::error::app_update_check.json is missing/empty"; exit 1; }
            grep -Eq '"(status|error)"[[:space:]]*:' app_update_check.json || { echo "::error::Unexpected /app/update/check payload"; cat app_update_check.json; exit 1; }
            echo "app/update/check endpoint reachable"
            echo "::endgroup::"
            adb logcat -d > logcat.txt 2>&1 || true

      - name: Upload logcat
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: emulator-logcat
          path: |
            logcat.txt
          retention-days: 7

  github-release:
    runs-on: ubuntu-latest
    needs:
      - android-apk-build
      - emulator-test
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout full git history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download release APK
        uses: actions/download-artifact@v4
        with:
          name: app-release-apk
          path: release-apk

      - name: Prepare release assets
        run: |
          set -euo pipefail
          mkdir -p release-assets
          cp -v release-apk/*.apk release-assets/
          cp -v release-apk/output-metadata.json release-assets/
          (
            cd release-assets
            sha256sum *.apk > SHA256SUMS.txt
          )

      - name: Build release notes body
        run: |
          set -euo pipefail
          current_tag="${GITHUB_REF_NAME}"
          prev_tag="$(git tag --list 'v*' --sort=-v:refname | awk -v cur="$current_tag" '$0 != cur { print; exit }')"
          range_spec="${current_tag}"
          if [ -n "${prev_tag}" ]; then
            range_spec="${prev_tag}..${current_tag}"
          fi

          commit_count="$(git rev-list --count "${range_spec}")"
          contributor_count="$(git log --format='%an' "${range_spec}" | sed '/^$/d' | sort -u | wc -l | tr -d ' ')"

          {
            echo "## Release Summary"
            echo
            echo "- Tag: \`${current_tag}\`"
            if [ -n "${prev_tag}" ]; then
              echo "- Previous tag: \`${prev_tag}\`"
              echo "- Compare: https://github.com/${GITHUB_REPOSITORY}/compare/${prev_tag}...${current_tag}"
            else
              echo "- Previous tag: none (first tagged release)"
            fi
            echo "- Commits in this release: ${commit_count}"
            echo "- Contributors: ${contributor_count}"
            echo
            echo "## Contributors"
            echo
            git log --format='- %an' "${range_spec}" | sed '/^$/d' | sort -u
            echo
            echo "## Changed Components"
            echo
            git diff --name-only "${range_spec}" \
              | awk -F/ '{print $1}' \
              | sed '/^$/d' \
              | sort \
              | uniq -c \
              | sort -nr \
              | awk '{printf("- %s (%s files)\n", $2, $1)}'
            echo
            echo "## Commits"
            echo
            git log --pretty=format:'- `%h` %s (%an)' "${range_spec}"
            echo
            echo "## APK Downloads"
            echo
            for apk in release-assets/*.apk; do
              base="$(basename "$apk")"
              echo "- \`$base\`"
            done
            echo
            echo "## SHA-256"
            echo
            echo '```text'
            cat release-assets/SHA256SUMS.txt
            echo '```'
          } > release-notes.md

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          body_path: release-notes.md
          files: |
            release-assets/*.apk
            release-assets/output-metadata.json
            release-assets/SHA256SUMS.txt
